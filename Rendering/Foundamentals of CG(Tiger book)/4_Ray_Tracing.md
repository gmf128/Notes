# 4.Ray Tracing

## 4.1 渲染方式的区别

目前的渲染方式主要分为了两种：

1. object-order rendering 以物体为中心出发点的，例如光栅化
2. image-order rendering 以图片像素为出发点，例如光追

image-order渲染更容易上手，并且在渲染风格上更加灵活，但是通常需要更多的执行时间。



## 4.2 透视原理

学的：线性透视

**值得关注：非传统透视，如鱼眼相机的应用可能性**

**射影几何（数学）**



## 4.3 简单的光追算法

主要分为三步：

1. 生成光线
2. 计算相交
3. 着色

### 4.3.1 生成光线

- 相机定义：

  ![]( https://box.nju.edu.cn/f/7d096be81d1a432789ac/?dl=1 )

  ![]( https://box.nju.edu.cn/f/8bc3f28ef33f4314a0d0/?dl=1 )

- 正交投影/透视投影图示·

  <img src=" https://box.nju.edu.cn/f/1a60a0bb21634414a751/?dl=1" style="zoom: 80%;" />

### 4.3.2 计算相交

#### 4.3.2.1 光线与球相交

由直线方程和球的方程联立得到一元二次方程。判断相交利用一元二次方程的判别式即可，如果需要求值则利用求根公式。

#### 4.3.2.2 光线与三角形相交

算法思想：分为两步

1. 求直线与三角形所在平面的交点（如不相交，结束）
2. 判断该交点是否在三角形内部

**采用重心坐标表示平面的方法，用重心坐标一石二鸟，一方面表达了平面方程，另一方面又能够通过求解快速地判断交点是否在三角形内**

设直线的表述为 **e** + t**d**，三角形三个顶点坐标分别为**a，b，c**，则只需要求解一下三元一次方程组
$$
\bold{e}+t\bold{d} = \bold{a}+\beta(\bold{b -a})+\gamma(\bold{c-a})
$$
由克莱姆法则可求具体解，当然，很多情况，如
$$
\beta <0,\ \beta>1,\ \gamma<0, \ \gamma>1-\beta
$$
等，由重心的定义可知落点不在三角形内部。

#### 4.3.2.3 光线与多边形相交

思路一：将多边形分为很多的三角形

思路二：

1. 求直线与多边形所在平面的交点（如不相交，结束）
2. 判断该交点是否在多边形内部。判断原理：将多边形和点投影到二维，注意保证不要讲多边形投影为一条直线；然后从待判断点出发发出任意一条射线，**若该射线与多边形交点为偶数个，则在多边形外；若交点为奇数个，则在多边形内。**
3. 在二维判断过程中，为方便起见，不妨设发出的射线永远是（1， 0）方向的。这样，我们得到了二维的射线方程，而多边形各个顶点坐标已知，因此判断射线与多边形的边的交点问题变为了n次线段与射线求交的问题。

#### 4.3.2.4 光线与多个物体相交

返回第一个相交的结果，即循环判断相交后取最小的t

### 4.3.3 着色

**重点：不同的着色模型**

在第四章中，只介绍最简单的两种着色模型。

绝大多数着色模型是在模拟光线反射这一过程，对于简单的着色模型，只支持点光源，重要的量：光线方向，视线方向和物体表面的法线。此外，物体材质信息的利用则因模型而异。

#### 4.3.3.1  Lambertian Shading

最简单的着色模型
$$
L = k_dImax(0,\ \bold{n\cdot l})
$$

$$
k_d:漫反射系数；I：光强； l:光线方向
$$

![]( https://box.nju.edu.cn/f/676a4eb675a047b0a27e/?dl=1 )

1. 与观察视角无关（无法表达高光等与视角有关的效果）
2. 只能支持点光源
3. 漫反射
4. 无反射、折射等

#### 4.3.3.2 Bling-Phong Shading

在漫反射的Lanmbient模型的基础上加上高光项。

高光的计算：如果观察方向和光的镜面反射方向相近，则有高光项，且越近越亮
$$
L = k_dImax(0,\ \bold{n\cdot l})+k_sImax(0,\ \bold{n\cdot h})^p
$$

$$
h = \frac{\bold{v}+\bold{l}}{||\bold{v}+\bold{l}||},\ \ denotes \ half \ vector
$$

![]( https://box.nju.edu.cn/f/7dea3cd1b522493f9230/?dl=1 )

#### 4.3.3.3 Ambient Shading

在Bling-Phong的基础上进一步增加了环境光项，得到了完整版的初级反射模型
$$
L = k_aI_a+k_dImax(0,\ \bold{n\cdot l})+k_sImax(0,\ \bold{n\cdot h})^p
$$
**对于多个点光源的情况：**
$$
L = k_aI_a+\sum_{i=1}^{N}k_dI_imax(0,\ \bold{n\cdot l_i})+k_sI_imax(0,\ \bold{n\cdot h_i})^p
$$


## 4.4 阴影(Shadow)

添加shadow的方法：在着色时，额外判断：该点到光源的射线是否与某个物体相交，若不相交，正常计算；否则颜色设为背景色。

注意：判断该点到光源的射线是否与物体相交时一般设置射线方程：
$$
\bold{e}+t\bold{d} ，\  t\in[\epsilon, +\infty]
$$
而非，
$$
\bold{e}+t\bold{d} ，\  t\in[0, +\infty]
$$
这是因为避免t=0时代表**自己遮挡自己**的误判。