# Chapter 9 Physically based Shading

## 9.1 Physics of Light

### 9.0.1 光是电磁波

<img src="Phisically%20Based%20Shading.assets/1688028828312.png" alt="1688028828312" style="zoom: 67%;" />

**上图，最简单的光，线性偏振且周期单一的光**

 “线偏振”（linearly polarized）是指电磁波的偏振状态，其中电场在一个平面内振荡。换句话说，电场矢量的振荡限定在特定的方向上。 

<img src="Phisically%20Based%20Shading.assets/1688028991451.png" alt="1688028991451" style="zoom:50%;" />

### 9.0.2 能量与干涉 

光波携带能量。**能量流密度等于电场和磁场幅度的乘积**，由于幅度成比例关系，**因此与电场幅度的平方成正比**。我们关注电场，因为它比磁场对物质的影响更加显著。

光是一种横波，当空间中存在不同的光波时，他们会线性叠加，继而产生干涉的效应。

下面这张图是n个相同频率但不同相位的光波组合的干涉图。图一：constructive interference 图二：destructive interference

图三：随机的相位叠加

<img src="Phisically%20Based%20Shading.assets/1688029224063.png" alt="1688029224063" style="zoom:50%;" />





 看起来，破坏性干涉和构造性干涉违反了能量守恒定律。但图9.3并没有展示完整的情况，它只显示了一个位置上的波相互作用。当波在空间中传播时，它们之间的相位关系会从一个位置变化到另一个位置，如图9.4所示。在某些位置上，波会构造性地干涉，合成波的辐照度大于各个波的辐照度之和。在其他位置上，它们会破坏性地干涉，导致合成辐照度小于各个波的辐照度之和。这并不违反能量守恒定律，因为通过构造性干涉获得的能量和通过破坏性干涉丧失的能量总是互相抵消的。 

<img src="Phisically%20Based%20Shading.assets/1688110850492.png" alt="1688110850492" style="zoom:50%;" />

 当物体中的电荷振荡时，会发射光波。引起振荡的能量的一部分（如热能、电能、化学能）会转化为光能，并从物体辐射出去。在渲染中，这样的物体被视为光源。 

 光波在发射后会通过空间传播，直到遇到某种物质进行相互作用。光与物质相互作用的核心现象是简单的，并且与上面讨论的发射情况非常相似。**振荡的电场推动着物质中的电荷，使其产生振荡。振荡的电荷会发射新的光波，将入射光波的部分能量以新的方向重新传播。这种反应被称为散射，是许多光学现象的基础。** 

 散射的光波具有与原始波相同的频率。通常情况下，原始波包含多个频率的光，每个频率的光都与物质分别发生相互作用。**不同频率的入射光能量不会贡献给不同频率的发射光能量，除非在特定而相对罕见的情况下，如荧光和磷光**

 一个孤立的分子会将光在各个方向上散射出去，强度在方向上可能有所变化。更多的光在靠近原始传播轴的方向上被散射，包括前向和后向。分子作为散射体的有效性，即在其附近的光波被散射的可能性，取决于光的波长的不同。**相对于较长波长的光，较短波长的光被散射得更加有效。** 

 在渲染中，我们关注的是许多分子的集合。光与这种组合体的相互作用不一定与孤立分子的相互作用相似。从附近分子散射的光波通常是相干的，并且会展示干涉现象，因为它们起源于相同的入射波。本节的其余部分将专注于多个分子散射的几个重要特殊情况。 

### 9.1.1 Particle 粒子

 在理想气体中，分子之间不相互影响，它们的相对位置是完全随机和不相关的。虽然这是一个抽象的概念，但对于正常大气压下的空气来说，这是一个相当好的模型。在这种情况下，从不同分子散射出的波之间的相位差是随机且不断变化的。结果，散射的波是不相干的，它们的能量线性叠加，就像图9.3右侧所示。换句话说，从n个分子散射的聚合光能量是从单个分子散射出的光能量的n倍。 

 相比之下，如果分子被紧密地聚集成比光波长小得多的团簇，每个团簇中散射的光波是相位一致且相互干涉的。这会导致散射波的能量二次叠加，就像图9.3左边所示。因此，从一个由n个分子组成的小团簇散射的光的强度是从单个分子散射的光的n²倍，比同样数量的分子在理想气体中散射的光要多n倍。**这种关系意味着在每立方米固定密度的分子情况下，将分子聚集成团簇会显著增加散射光的强度。将团簇变大（同时保持总体分子密度恒定）将进一步增加散射光的强度，直到团簇直径接近光波长为止。在那一点之后，继续增加团簇的大小将不会进一步增加散射光的强度。**

 **这个过程解释了为什么云和雾会强烈地散射光线。它们都是通过凝结过程形成的，即空气中的水分子聚集成越来越大的团簇。这显著增加了光的散射，即使水分子的总体密度没有改变。** 

 在讨论光散射时，术语"粒子"用于同时指代孤立的分子和多分子团簇。由于直径小于波长的多分子粒子的散射是对孤立分子散射的放大版本（通过构造性干涉），所以它表现出相同的方向变化和波长依赖性。这种类型的散射在大气粒子的情况下被称为瑞利散射，在嵌入固体的粒子的情况下被称为泰因德尔散射 

 This type of scattering is called **Rayleigh scattering** in the case of atmospheric particles and **Tyndall scattering** in the case of particles embedded in solids. 

 当粒子的尺寸超过一个波长时，散射波不再在整个粒子上处于相位一致的事实改变了散射的特性。散射越来越倾向于正向方向，波长依赖性也会减小，直到所有可见光波长的光都被均等地散射。这种类型的散射被称为米氏散射。 （Mie Scattering）

### 9.1.2 Media 介质

 另一个重要的情况是光在**均匀介质(homogeneous)**中传播，即充满均匀间隔的相同分子的体积。分子间的间距不必像晶体那样完全规则。液体和非结晶固体在其组成纯净（所有分子相同）且没有间隙或气泡的情况下可以是光学均匀的。 

 在均匀介质中，散射波被排列成相干地干涉，以至于它们在除了原始传播方向以外的所有方向上都发生破坏性干涉。当原始波与散射自各个分子的所有波相结合时，最终结果与原始波相同，除了它的相速度和（某些情况下）振幅。最终的波不表现出任何散射，它实际上被破坏性干涉所抑制。 

 **原波和新波的相速度之比定义了介质的光学属性，称为折射率**（Index of Refraction，IOR），用字母n表示。一些介质具有吸收性，它们将部分光能转化为热能，导致波的振幅随距离呈指数衰减。**衰减速率由衰减指数（Attenuation Index）定义**，用希腊字母κ（kappa）表示。折射率n和衰减指数κ通常随波长变化。这两个参数共同完全描述了介质对给定波长的光的影响，**它们通常被合并为一个复数n + iκ，称为复折射率（Complex Index of Refraction )**

**即：折射率的实数部分表示介质对光的传播速度的影响，虚数部分表示介质对光能的吸收影响**

 折射率摒弃了光与分子级细节的相互作用，并使得可以将介质视为连续的体积，从而简化了处理过程 。

 非均匀介质常常可以被建模为具有散射颗粒的均匀介质。在均匀介质中抑制散射的破坏性干涉是由于分子的均匀排列，以及它们产生的散射波的均匀性。分子分布中的任何局部变化都会打破这种破坏性干涉的规律，使得散射的光波能够传播。这样的局部变化可以是不同分子类型的团簇、气体间隙、气泡或密度变化。无论哪种情况，它都会像之前讨论的颗粒一样散射光线，其散射特性与团簇的大小有关。甚至气体也可以用这种方式建模。对于气体，"散射颗粒"是由分子的不断运动引起的瞬时密度波动。该模型使得能够建立气体的有意义的折射率n值，对于理解气体的光学性质非常有用。

 散射和吸收都与尺度有关。在小尺度的场景中，一个介质可能看起来没有明显的散射，但在较大尺度下可能会有明显的散射。例如，在观察一个房间里的一杯水时，空气中的光散射和水中的吸收是不可见的。然而，在广阔的环境中，这两种效应都可能非常显著 。

 在一般情况下，介质的外观是由散射和吸收的组合所引起的，如图9.8所示。散射的程度决定了cloudiness，高度散射会产生不透明的外观。除了一些罕见的例外，如图9.6中的乳白色玻璃，固体和液体介质中的颗粒往往比光的波长大，并倾向于等量地散射所有可见波长的光。因此，任何色彩色调通常是由吸收的波长依赖性引起的。介质的亮度是这两种现象的结果。**尤其是白色是高度散射和低吸收的组合结果**。这在第14.1节中有更详细的讨论。 

<img src="Phisically%20Based%20Shading.assets/1688115190896.png" alt="1688115190896" style="zoom:67%;" />

### 9.1.3 Surface表面

**折射率**

从光学的角度来看，物体表面是一个二维界面，分隔了具有不同折射率的两个区域。在典型的渲染情况下，外部区域包含空气，其折射率约为1.003，通常为了简化起见会假设为1。而内部区域的折射率取决于物体所制成的物质。

当光波击到表面时，表面的两个方面对结果有重要影响：表面两侧的物质和表面的几何形状。我们首先关注物质方面，假设最简单的表面几何形状为完全平坦的平面。我们将“外部”（入射波起源的一侧）的折射率表示为n1，将“内部”（光波通过表面后将被传输的一侧）的折射率表示为n2

 在前面的部分我们已看到，光波在遇到介质组成或密度发生不连续性时，即折射率发生改变时会散射。**将不同折射率的平面分开的表面是一种特殊类型的不连续性**，它以特定的方式散射光线。边界条件(The Boundary Condition)要求平行于表面的电场分量是连续的。换句话说，电场矢量在表面平面上的投影必须在表面的两侧保持一致。这有几个含义：

1.  在表面上，任何散射波必须与入射波相位相同或相位差为180°。因此，在表面上，散射波的峰值必须与入射波的峰值或谷值对齐。这将限制散射波只能沿着两个可能的方向传播，一个是继续向表面内传播，另一个是远离表面。其中第一个是透射波（transmitted wave），第二个是反射波 

2.  散射波必须与入射波具有相同的频率。在这里，我们假设是单色波，但可以通过首先将一般波分解为单色分量来应用于任何波。 

3.  当光波从一个介质移动到另一个介质时，相速度——波在介质中传播的速度——按比例变化于相对折射率（n1/n2）。由于频率是固定的，波长也按比例变化于（n1/n2 )

**Snell`s law**
$$
sin(\theta_t) = \frac{n_1}{n_2}sin(\theta_i)
$$
 尽管折射通常与如玻璃和晶体等透明材料相关联，但它也发生在不透明物体的表面上。当不透明物体发生折射时，光在物体内部经历散射和吸收。光与物体的介质相互作用，就像图9.8中的各种液体杯子一样。对于金属而言，内部含有许多自由电子（未与分子结合的电子），它们“吸收”折射光能量并将其重定向到反射波中。这就是为什么金属既具有高吸收性又具有高反射性的原因。 

 我们所讨论的表面折射现象——反射和折射——需要在小于一个波长的距离内发生折射率的突然变化。折射率的更渐变变化不会使光线发生分裂，而是使其路径弯曲，类似于连续地发生折射。这种效应通常可以在空气密度因温度而变化时看到，如幻影和热扭曲。请参见图9.10。 

 即使具有明确边界的物体完全浸入与其具有相同折射率的物质中，也不会有可见的表面。在没有折射率变化的情况下，反射和折射无法发生。 下图，小球的折射率与水相同，在水下的部分很难看出明显的表面

<img src="Phisically%20Based%20Shading.assets/1688282058882.png" alt="1688282058882" style="zoom:50%;" />

**表面几何**

 到目前为止，我们已经关注了表面两侧物质对表面外观的影响。现在我们将讨论影响表面外观的另一个重要因素：几何形状。严格来说，完全平坦的平面表面是不可能的。每个表面都具有某种形式的不规则性，即使只是构成表面的单个原子。然而，远小于波长的表面不规则对光线没有影响，而远大于波长的表面不规则则表现为宏观上的表面的倾斜，不影响其微观局部的平坦性。**只有在1-100个波长范围内的不规则性使得表面的行为与平坦平面不同，通过一种称为衍射的现象**。在第9.11节中将进一步讨论这个现象。 

 **在渲染中，我们通常使用几何光学，它忽略了波动效应，如干涉和衍射。这相当于假设所有的表面不规则性要么比光波长小，要么大得多。在几何光学中，光被建模为射线而不是波动。当光线与表面相交时，该表面在局部被视为平坦的平面**。图9.9右下方的图示可以看作是反射和折射的几何光学图像，与该图其他部分呈现的波动图像形成对比。从现在开始直到第9.11节，我们将坚持使用几何光学领域，9.11节专门讨论基于波动光学的着色模型的主题。 

 正如之前提到的，远大于波长的表面不规则性会改变表面的局部方向。**当这些不规则性太小而无法单独进行渲染，换句话说，小于一个像素，我们将其称为微几何(microgeometry)**。反射和折射的方向取决于表面法线。**微几何的效果是在表面的不同点上改变法线，从而改变了反射和折射的光线方向**。
尽管表面上的每个特定点只能以单一方向反射光线，但每个像素覆盖了许多以不同方向反射光线的表面点。外观是由所有不同反射方向的聚合结果驱动的。**图9.12显示了两个在宏观尺度上具有相似形状但微几何明显不同的表面的示例**。
在渲染中，我们不是明确地建模微几何，而是将其统计处理，**将表面的微结构法线建模为随机分布**。因此，我们将表面建模为在连续的范围的方向上反射（和折射）光线。这个范围，以及反射和折射细节的模糊程度，取决于微几何法线向量的统计方差，换句话说，取决于表面的微观尺度粗糙度。参见图9.13。（**理解：将表面法线的方向视作随机正态分布 （当然，也可能是其他分布），表面粗糙度自然就体现为这个随机分布的方差**）

>  For rendering, rather than modeling the microgeometry explicitly, we treat it statistically and view the surface as having a random distribution of microstructure normals. As a result, we model the surface as reflecting (and refracting) light in a continuous spread of directions. The width of this spread, and thus the blurriness of reflected and refracted detail, depends on the statistical variance of the microgeometry normal vectors—in other words, the surface microscale roughness. See Figure 9.13 

<img src="Phisically%20Based%20Shading.assets/1688282760033.png" alt="1688282760033" style="zoom:67%;" />

###  9.1.4 Sub-surface scattering 次表面散射

折射光继续与物体内部体积进行相互作用。如前所述，金属反射大部分入射光，并迅速吸收剩余部分。相反，非金属表现出各种各样的散射和吸收行为。**具有低散射和吸收的材料是透明的**，将任何折射光传递到整个物体中。有关在不使用折射的情况下渲染此类材料的简单方法已在5.5节中讨论过，并且在14.5.2节中将详细介绍折射。在本章中，我们将重点讨论**不透明物体（这意味着光要么被吸收，要么重新散射出来）**，其中传输光经历多次散射和吸收事件，直到最终一部分光线从表面重新发射出来。参见图9.14 

<img src="Phisically%20Based%20Shading.assets/1688285682350.png" alt="1688285682350" style="zoom:50%;" />

上图： 折射光在穿过物质时会经历吸收。在这个例子中，大部分吸收发生在较长波长处，主要留下了短波长的蓝光。此外，它还会从物质内部的粒子中发生散射。最终，一些折射光会被散射回表面，就像蓝色箭头以各种方向离开表面所示 。

 **次表面散射中，离开表面的光的射出点与进入点有着不同的距离。进出距离的分布取决于物质中散射粒子的密度和属性。这些距离和着色尺度（像素大小或着色样本点之间的距离）之间的关系非常重要。**如果进出距离与着色尺度相比较小，可以假设对于着色效果来说进出距离几乎为零。这使得次表面散射可以与表面反射结合成为一个局部着色模型，出射光线仅取决于同一点的入射光线。然而，由于次表面散射光与表面反射光具有明显不同的外观，将它们分为单独的着色项更为方便。镜面项模拟表面反射，漫反射项模拟局部次表面散射。 

 如果进出距离与阴影比例尺相比较大，则需要使用专门的渲染技术来捕捉光线从一个点进入表面并从另一个点离开的视觉效果。这种全局次表面散射技术在14.6节中有详细介绍。局部和全局次表面散射之间的差异在图9.15中有所说明。 

 需要注意的是，局部和全局次表面散射技术模拟的是完全相同的物理现象。对于每种情况的最佳选择不仅取决于材质属性，还取决于观察的尺度。例如，在渲染一个孩子玩耍的场景时，充分还原孩子的皮肤可能需要使用全局技术，而对于玩具则足够使用局部漫反射着色模型。**这是因为皮肤中的散射距离要比塑料大得多**。然而，如果摄像机足够远，皮肤的散射距离将小于一个像素，局部着色模型对于孩子和玩具来说都是准确的。**相反，在极近距离的特写镜头中，塑料材质会显示出明显的非局部次表面散射，需要使用全局技术来准确渲染玩具。** 

<img src="Phisically%20Based%20Shading.assets/1688299960485.png" alt="1688299960485" style="zoom:67%;" />

## 9.2 Camera

 在渲染中，我们计算从着色的表面点到相机位置的辐亮度。这模拟了一种成像系统的简化模型，如胶片相机、数码相机或人眼 

 这种系统包含一个由许多离散小传感器组成的传感器表面。例如，眼睛中的视杆细胞和视锥细胞，数码相机中的光电二极管或胶片中的染料颗粒。每个传感器检测其表面上的辐照度值，并产生一个颜色信号。辐照度传感器本身无法产生图像，因为它们平均了来自所有入射方向的光线。因此，完整的成像系统包括一个防光的封闭装置，它具有一个小孔（开口），限制了光线可以进入并触碰传感器的方向。放置在光圈的透镜将光线聚焦，使每个传感器只接收来自一小组入射方向的光。封闭装置、光圈和透镜的组合效果使得传感器具有方向性。它们对小区域和一小组入射方向上的光线进行平均。传感器不是测量平均irradiance（正如我们在8.1.1节中所看到的，它量化了来自所有方向的光流密度），而是测量平均radiance，它量化了单个光线的亮度和颜色。 

 在历史上，渲染一直模拟了一种特别简单的成像传感器，称为针孔相机，如图9.16顶部所示。针孔相机具有极小的光圈，在理想情况下是一个零尺寸的数学点，并且没有透镜。点状光圈使得传感器表面上的每个点只能收集一束光线，具有离散传感器的光线锥的底部覆盖传感器表面，其尖顶位于光圈处。渲染系统以稍微不同（但等效）的方式模拟针孔相机，如图9.16中部所示。针孔光圈的位置由点c表示，通常称为“相机位置”或“视点”。该点也是透视变换（第4.7.2节）的投影中心.

下面的图最上面是小孔成像

<img src="Phisically%20Based%20Shading.assets/1688305634474.png" alt="1688305634474" style="zoom:50%;" />

**在渲染过程中，每个shading采样对应于一条射线，因此对应于传感器表面上的一个采样点。抗锯齿过程（5.4节）可以解释为对每个离散的传感器表面进行信号重建。然而，由于渲染不受物理传感器的限制，我们可以更一般地将其视为从离散采样中重建连续图像信号的过程。**

尽管实际上已经构建了针孔相机，**但它们对于实际使用的大多数相机以及人眼来说都是较差的模型。**图9.16底部显示了使用透镜的成像系统模型。包括透镜可以使用较大的光圈，大大增加成像系统收集到的光量。然而，这也导致相机具有有限的景深（12.4节），使得过近或过远的物体模糊。

透镜除了限制景深之外，还有一个额外的效果。即使对于完美对焦的点，每个传感器位置也会接收到光线锥。理想化的模型中，每个shading采样代表一个单独的视野射线，但有时可能会引入数学奇点、数值不稳定性或视觉混叠。

在渲染图像时，牢记物理模型可以帮助我们识别和解决这些问题。

## 9.3 BRDF

PBR:需要我们定量计算radiance
$$
L_i(\textbf{c}, \ \textbf{-v})
$$
这里 **c**表示相机所在的点，**v**是view ray的方向，指向相机，因此在表达式里是 **-v**

 在渲染中，**场景通常被建模为由对象以及对象之间的介质组成的集合**（“介质"一词实际上来自于拉丁词"中间"或"之间”）。通常情况下，介质是适量的、相对清洁的空气，对光线的辐射强度没有明显影响，因此在渲染过程中可以忽略介质。有时光线会穿过能通过吸收或散射显著影响其辐射强度的介质。**这类介质被称为参与介质，因为它们参与光线在场景中的传输。参与介质将在第14章中详细介绍。在本章中，我们假设不存在参与介质，因此进入相机的辐射强度等于沿着相机方向离相机最近的对象表面离开的辐射强度。即：** 
$$
L_i(\textbf{c}, \textbf{-v}) = L_o(\textbf{p}, \textbf{v}) \tag{9.1}
$$
这里 **p**是view ray和最近物体的交点

根据公式9.1，我们现在的计算目标转为计算$L_o(p, v)$, 而这可能存在两种情况：

1. p点自身发射的光线
2. p点反射的光线或局部次表面散射

在这里，我们先不考虑透明物体的折射或是全局次表面散射。我们只考虑 **局部反射现象，它将击中当前着色点的光线重新定向向外部。这些现象包括表面反射以及局部次表面散射，只取决于入射光方向l和出射视线方向v。局部反射由双向反射分布函数（BRDF）来量化** 

 BRDF是针对均匀表面定义的。也就是说，假设BRDF在整个表面上是相同的。**（传统BRDF：4维，只有射入方向+射出方向）**然而，现实世界中的物体（以及渲染场景中的物体）很少在其表面上有均匀的材料特性。即使是由单一材料组成的物体，例如由银制成的雕像，也会有划痕、变色斑点、污渍和其他变化，使其视觉特性从一个表面点到另一个表面点发生变化。从**技术上讲，基于空间位置捕捉BRDF变化的函数被称为空间变化的BRDF（SVBRDF）或空间BRDF（SBRDF）**。**然而，在实践中这种情况非常普遍，通常使用更简短的术语BRDF，并默认假设其依赖于表面位置。（实践中常用SVBRDF）** 

![1688370910565](Phisically%20Based%20Shading.assets/1688370910565.png)

**BRDF的自由度：4；各向同性的BRDF的自由度：3，各向同性的含义： 当传入和传出方向围绕表面法线旋转时保持相同的相对角度时，光学性质保持不变 ，也就是只需要知道传入传出方向的相对教就够了，因此自由度从4降为3.**

 在忽略荧光和磷光等现象的情况下（补充材料1），我们可以假设给定波长的入射光以相同的波长被反射。反射的光量可能会根据波长的不同而变化，可以通过两种方式进行建模。一种方式是将波长视为BRDF的附加输入变量，另一种方式是将BRDF视为返回具有光谱分布的值。虽然第一种方法有时用于离线渲染，**但在实时渲染中始终使用第二种方法。由于实时渲染器将光谱分布表示为RGB三元组，这意味着BRDF只返回一个RGB值。** 

#### **补充材料1**

解释： 在忽略荧光和磷光等现象的情况下（补充材料1），我们可以假设给定波长的入射光以相同的波长被反射

>  散射的光波具有与原始波相同的频率。通常情况下，原始波包含多个频率的光，每个频率的光都与物质分别发生相互作用。**不同频率的入射光能量不会贡献给不同频率的发射光能量，除非在特定而相对罕见的情况下，如荧光和磷光**

>  **磷光的原理**：当某种常温物质经某种波长的入射光（通常是紫外线或X射线）照射，吸收光能后进入激发态（通常具有和基态不同的自旋多重度），**然后缓慢地退激发并发出比入射光的波长长的出射光**。 （**与时间相关**）
>
> **荧光（fluorescence）**
>
> **一般来说，荧光具有比入射光更低的能量，相应的波长比入射光更长**。

 [全光函数、BTF、SVBRDF、BSSRDF、BRDF 之间的联系 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/410039298) 

 ![img](Phisically%20Based%20Shading.assets/v2-0ac671e3258c24c493db4ad160029227_r.jpg) 

#### reflectance equation:

$$
L_o(p, v) = \sum_{l_i}f(l_i, v)H_{l_i} = \sum_{l_i}f(l_i,v)L_i(p, l_i)d\sigma_i
$$

令$||\sigma_i|||\to 0$,得到渲染方程：
$$
L_o(p,\  v) = \int_{l\in \Omega}f(l, \ v)L_i(p, \ l)(n\cdot l)dl \tag{9.2}
$$

 请注意，l在传入方向的半球上连续扫过，并不代表特定的"光源方向"。这个想法是任何传入方向都可以（通常会）与一定的辐射度相关联。我们用**dl表示围绕l的微分立体角** 

在下文中，可能将p省略，9.2写为：
$$
L_o(\textbf{v}) = \int_{\textbf{l}\in \Omega}f(\textbf{l},\ \textbf{v})\ L_i(\textbf{l})\ (\textbf{n}\cdot \textbf{l})\ d\textbf{l}\tag{9.3}
$$
 进一步求解9.3时，可以采用球坐标换元，这在虎书上已经记过了。

另一种换元方法是$\mu = \cos \theta,\ \phi = \phi$

那么立体角微元满足：
$$
d\textbf{l} = d\mu d\phi
$$

$$
L_o(\mu_o, \phi_o) = \int_{\phi_i=0}^{2\pi}\int_{\mu_i=0}^{1}f(\phi_i,\mu_i,\mu_o,\phi_o)\ L_i(\phi_i,\mu_i)\ (\mu_i)\ d\mu_i d\phi_i \tag{9.4}
$$

物理定律对任何BRDF都有两个限制。**第一个限制是亥姆霍兹互易性（Helmholtz reciprocity）**，这意味着输入和输出角度可以互换，而函数的值将保持不变 ，**即BRDF具有交换性**

 在实际应用中，用于渲染的BRDF常常会违反亥姆霍兹互易性，而不会产生明显的artifact，除非特定要求互易性的离线渲染算法（如双向路径追踪）才会出现。然而，判断一个BRDF是否在物理上可信时，亥姆霍兹互易性仍然是一个有用的工具。 

 **第二个约束是能量守恒**，即输出的能量不能超过输入的能量（不包括发光表面向外发射光的情况，这被视为特殊情况处理）。像路径追踪这样的离线渲染算法需要能量守恒以确保收敛性。对于实时渲染来说，完全的能量守恒并非必需，但是近似的能量守恒是重要的。使用严重违反能量守恒的BRDF进行渲染会使表面过亮，从而看起来不真实 

这里引入 方向-半球反射率R(l) （ The directional-hemispherical reflectance R(l) ）

 它测量了从给定方向射入的光在半球面内，以任意出射方向被反射的量。基本上，它测量了给定入射方向的能量损失。该函数的输入是入射方向向量l，并且其定义如下： 
$$
R(\textbf{l}) = \frac{E}{H}=\int_{v\in \Omega}\frac{L_o(v)(n\cdot v)}{H}d\sigma
\\=\int_{v\in \Omega} f(\textbf{l}, \textbf{v})(\textbf{n}\cdot \textbf{v})d\textbf{v}\\
E:exitance \ irradiance ;\ H:irradiance
$$


**方向-半球反射率R(l)的值必须始终在[0, 1]范围内，这是能量守恒的结果**。反射率为0表示所有入射光都被吸收或以其他方式丢失的情况。如果所有的光都被反射，反射率将为1。在大多数情况下，它将介于这两个值之间。与BRDF类似，R(l)的值随着波长而变化，**因此在渲染过程中它被表示为RGB向量**。由于每个分量（红色、绿色和蓝色）限制在[0, 1]范围内，R(l)的值可以被看作是一个简单的颜色。请注意，这种限制不适用于BRDF的值。作为一个分布函数，如果所描述的分布在某些方向上高度不均匀，BRDF的值可以是任意高的（比如高光的中心）。BRDF满足能量守恒的要求是对于所有可能的l值，R(l)不能大于1。 

最简单的BRDF是Lambertian ,下面我们来推导一下Lambertian的相关公式以加深理解。

首先，由于是Lambertian，具备以下性质：

1. BRDF是常数
2. 均匀的漫反射

假设$f(\textbf{l}, \textbf{v}) = c, for\ all\  \textbf{l}, \textbf{v}$，那么由方向-半球反射率的定义可以推导出：
$$
R(l) = \int_{0}^{2\pi}\int_{0}^{\frac{\pi}{2}}c*\cos{\phi}\sin{\phi}d\phi d\theta \\
= \pi c
$$
 **Lambertian BRDF的恒定反射率值通常被称为漫反射颜色*****(diffuse color)**$c_{diff}$或**反照率(albedo)**$ρ$。在本章中，为了强调与次表面散射的关联，我们将将这个量称为次表面反照率$ρ_{ss}$。次表面反照率在第9.9.1节中详细讨论。从方程9.10得到的BRDF给出以下结果： 
$$
f(l,v) = \frac{\rho_{ss}}{\pi}\tag{9.5}
$$
![1688455618092](Phisically%20Based%20Shading.assets/1688455618092.png)

上图，BRDF的可视化。 理解BRDF的一种方式是以固定输入方向的方式进行可视化。参见图9.18。对于给定的入射光方向，BRDF的值在所有出射方向上都被显示出来。交点周围的球状部分表示漫反射成分，因为出射辐射有相等的机会在任何方向上反射。椭球形部分是镜面亮斑。这样的亮斑自然位于从入射光的反射方向上，亮斑的厚度与反射模糊度相对应。根据互易原理，这些相同的可视化也可以被理解为每个不同的入射光方向对单个出射方向的贡献量 

#### 补充材料2：

**"Background: Physics and Math of Shading by Naty Hoffman"**

 中对BRDF给出了更详细的叙述。

这里首先需要补充光的波长与RGB的映射关系。这里我记到虎书的笔记中了，因为虎书与RT的内容基本相同，但感觉更详细。见虎书Colormetry

//TODO:补充这部分内容

将9.3的公式进一步严谨地细化为：
$$
L_o(\textbf{v}) = \int_{\textbf{l}\in \Omega}f(\textbf{l},\ \textbf{v})\otimes L_i(\textbf{l})\ (\textbf{n}\cdot \textbf{l})\ d\textbf{l}\tag{9.3}
$$
这里运算符$\otimes$表示逐分量乘积

>   The ⊗ symbol is used here to denote component-wise vector multiplication; it is used because both BRDF and light color are spectral (RGB) vectors.  

## 9.4 Illumination

 反射方程（方程9.4）中的Li(l)（入射辐射）项表示来自场景其他部分的光线照射到着色表面点上。全局照明算法通过模拟光线在整个场景中的传播和反射来计算Li(l)。**这些算法使用渲染方程[846]，而反射方程是其特殊情况**。全局照明在第11章中进行了讨论。在本章和下一章中，我们专注于局部照明，它使用反射方程在每个表面点局部计算阴影。在局部照明算法中，Li(l)是给定的，无需计算。 

 在真实场景中，Li(l)包括来自所有方向的非零辐射，无论是直接从光源发射还是从其他表面反射而来。与第5.2节讨论的定向光和点光源不同，现实世界中的光源是覆盖非零立体角的面光源。在本章中，我们使用Li(l)的一种受限形式，只包括定向光和点光源，将更一般的照明环境留给第10章。这种限制将使得讨论更加专注。 

 虽然点光源和定向光是非物理抽象，但它们可以作为物理光源的近似推导出来。这样的推导非常重要，因为它使我们能够将这些光源置于基于物理的渲染框架中，并确信我们理解其中涉及的误差。

**方向光：**方向光可以视为光源在很远的位置，大小可以忽略。定义$l_c$为光的方向**重点是如何定义光的颜色。**

**光的颜色的定义： reflected radiance from a white Lambertian surface facing toward the light (n = lc) **即白色的正对光线的朗博体的反射radiance，记为$c_{light}$

( 点光源由光颜色(clight)和光方向向量(lc)参数化。**为了方便艺术家，clight并不对应于光强度的直接辐射测量；它被指定为当平行于表面法线(n)的光照射到一个白色朗伯面时，该面具有的颜色**。与我们所见的其他颜色量一样，clight是以光谱（RGB）值表示的，但与它们不同的是它的范围是无限的 )

对点光源和平行光的illumination推导：

### 9.4.1 Punctual light(点光源)

 点光源的主要优势在于它们极大地简化了反射方程，我们将在这里展示。我们将从定义一个以$l_c$为中心、具有小角度范围ε的微小面积光源开始。这个微小的面积光源用入射辐射函数$L_{tiny}(l)$照亮一个shading表面点。入射辐射函数具有以下两个属性： 
$$
\forall l |\ang l,l_c \gt\epsilon, \ L_{tiny}(l) = 0\tag{9.6.1}
$$

$$
c_{light} = \frac{1}{\pi}\int_{\Omega}L_{tiny}(l)(n\cdot l)dw\ \  ,when\ l_c=n\tag{9.6.2}
$$

其中性质2（即9.6.2）的解释如下：

- 这是$c_{light}$的定义式

- 利用$c_{light}$的定义，它被指定为当垂直于表面法线(n)的光照射到一个白色朗伯面时，该面具有的颜色。
- 因此，根据公式9.5，BRDF应当被定义为$\frac{1}{\pi}$，再根据反射方程9.2，可得结果

**注意，上面的公式9.6.2并不只对点光源成立，也不只对某个$\epsilon$成立，因此可以对两边取极限。**

**对公式9.6.2取极限以逼近点光源：**
$$
c_{light} = \lim_{\epsilon \to 0^+}(\frac{1}{\pi}\int_{\Omega}L_{tiny\_in}(l)(n\cdot l)dw_i)\  (l_c = n)\tag{9.7}
$$
忽略介质影响，
$$
L_{tiny\_in}(l) = L_{tiny\_out}(-l) \tag{9.8}
$$
下记$L_{tiny\_in} = L_{tiny}$

由性质9.6.1，可得：
$$
\int_\Omega L_{tiny}(l)(\cos\epsilon)\ dw_i\le\int_\Omega L_{tiny}(l)(n\cdot l)dw_i\le\int_{\Omega}L_{tiny}(l)dw_i
$$

由夹逼原则：
$$
\int_{\Omega}L_{tiny}(l)dw_i收敛，且
$$

$$
\pi c_{light}=\lim_{\epsilon \to 0^+}(\frac{1}{\pi}\int_{\Omega}L_{tiny}(l)(n\cdot l)dw_i) = \lim_{\epsilon \to 0^+}(\frac{1}{\pi}\int_{\Omega}L_{tiny}(l)dw_i)\tag{9.9}
$$

对于$l_c \neq n$的情况，我们可以得到：
$$
L_o = \frac{1}{\pi}\int_{\Omega}L_{tiny}(l)(n\cdot l)dw_i
$$
由基于三余弦的空间角关系推理：

![1694274109314](Phisically%20Based%20Shading.assets/1694274109314.png)
$$
\cos\epsilon\cdot\cos(\theta+\epsilon)\int_{\Omega}L_{tiny}(l)dw_i\le \int_{\Omega}L_{tiny}(l)(n\cdot l)dw_i \le \cos(\theta-\epsilon)\int_{\Omega}L_{tiny}(l)dw_i \tag{9.10}
$$
关键问题是，当$l_c\neq n$时，我们似乎无法确定$L_{tiny}(l)$的分布

**这时，需要用到关系9.8**:

<img src="Phisically%20Based%20Shading.assets/1694274376913.png" alt="1694274376913" style="zoom: 25%;" />

可见，无论$l_c$与n的关系如何，P点接受的radiance都等于光源同一区域发出的radiance，因此：
$$
\pi c_{light}\equiv \lim_{\epsilon \to 0^+}(\frac{1}{\pi}\int_{\Omega}L_{tiny}(l)dw_i)\tag{9.11}
$$
9.11式的成立与$l_c$和n的位置关系无关。

进而我们得到(9.10式+夹逼原理)：
$$
L_o= \lim_{\epsilon\to 0^+}\int_{\Omega}L_{tiny}(l)(n\cdot l)dw_i \\= cos\theta\cdot \lim_{\epsilon \to 0^+}(\frac{1}{\pi}\int_{\Omega}L_{tiny}(l)dw_i)
 \\=cos\theta\cdot\pi \ c_{light} \tag{9.12} = \pi c_{light}(n\cdot l_c)
$$
再进一步，对一般的BRDF(非lambertian)
$$
L_o(v) = \lim_{\epsilon\to 0^+}\int_{\Omega}f(l, v)\otimes L_{tiny}(l)(n\cdot l)dw_i = f(l_c, v)(\pi c_{light})(n\cdot l_c) \tag{9.13}
$$
(此处严谨的数学推导可能要用到积分第二中值定理)

与原始的反射方程(9.2)相比，我们用单个BRDF**的替代了积分计算**，这样计算起来更加廉价。

在游戏中，常常将方程9.13中的点积**clamp至0**，作为一种跳过背面光照贡献的便捷方法。 
$$
L_o(v) = f(l_c, v)\pi c_{light}(n\cdot l_c)^+ \tag{9.14}
$$
对于定向光源（如太阳）的情况下，场景中的$l_c$和$c_{light}$均为常数。而对于其他点光源和聚光灯等其他光源类型，两者会变化。实际上，$c_{light}$会按**距离平方反比递减**，但在实践中通常使用其他衰减函数（出于性能考虑，衰减函数在有限距离内趋近于0，可以将远距离的物体的光照计算剔除，或出于艺术喜好）。 如果有多个点光源照明表面，则方程9.13将会计算多次，并将结果相加。

点光源很少单独使用，因为缺乏来自其他方向的照明会很明显，特别是在高度镜面的表面上。因此，点光源通常与某种环境光（ambient light）或基于图像的光照相结合。 

**解惑·：当$l_c\neq n$时，这个“距离平方反比”的距离仍然是目标点与光源的距离，且$c_{light}$平方反比的关系不影响9.11/9.12等公式的推导（可以思考一下）**

## 9.5 Fresnel Reflectance

 光与两个物质之间的平面界面的相互作用遵循  Augustin-Jean Fresnel （1788-1827年，发音为freh-nel）所发展的菲涅耳(Fresnel)方程。菲涅耳方程要求一个平坦的界面，**符合几何光学的假设**。换句话说，**假设表面在1个光波长到100个光波长的尺寸范围内没有任何不规则性**。小于这个范围的不规则性对光没有影响，而更大的不规则性有效地使表面倾斜，但不会影响其局部平整度。 

照射在平面表面上的光会分为反射部分和折射部分。反射光的方向（由矢量$r_i$表示）与入射方向l相对于表面法线n形成相同的角度$\theta_i$。反射矢量$r_i$可以由n和l计算得到： 
$$
\mathbf{r_i} = 2(\mathbf{n}\cdot \mathbf{l})\mathbf{n} - \mathbf{l}\tag{9.15}
$$
 **The amount of light reflected (as a fraction of incoming light) is described by the Fresnel reflectance F**, which depends on the incoming angle θi .  

F表示被反射的光的量占比(与折射等比较)

### 9.5.1 External reflection

 在外部反射的情况下，满足n1 < n2。换句话说，光线起源于折射率较低的表面一侧。通常情况下，这一侧是空气，其折射率约为1.003。为了简化起见，我们将假设n1 = 1。相反的情况，即从物体到空气的情况，称为内部反射，在第9.5.3节中将进行讨论。 

对于确定的物质，fresnel方程将被表示为一个函数：$F(\theta_i)$此处$\theta_i$是入射角，理论上F应随波长变化(spectual)，在实践中表示为一个RGB向量。F满足以下性质：

-  当θi = 0°时，表示入射光垂直于表面（l = n）时，F(θi)的值是物质的属性。这个值被称为F0，可以被看作是物质的特征镜面反射颜色。当θi = 0°时的情况被称为法线入射。 
-  随着θi的增加，光线以越来越倾斜的角度击中表面，F(θi)的值将趋于增加，并在θi = 90°时达到1的数值（全频率为白色）。全1的原因：当入射角趋近1时，几乎全部的光都离开表面(反射)，而非进入表面(折射) 

<img src="Phisically%20Based%20Shading.assets/1694324647989.png" alt="1694324647989" style="zoom:67%;" />

 图解：外部反射的菲涅耳反射率F分别对应三种物质：玻璃、铜和铝（从左到右）。顶部一行显示了F作为波长和入射角的三维图。第二行显示了每个入射角对应的F的光谱值，转换为RGB并分别作为每个颜色通道的曲线进行绘制。玻璃的曲线重合，因为它的菲涅耳反射率是无色的。在第三行，将R、G和B曲线绘制在入射角的正弦值为横轴的图上，以考虑下图中所示的长度缩短效应。底部一行的条带使用相同的 x 轴，展示了RGB值对应的颜色。 

 在镜面反射的情况下，出射或视角与入射角相同。(眼睛能看到点，说明出射光线就是视线，因而出射角就是视角，因而就是入射角)，**这意味着与入射光成极端角度的表面（θi接近90°）也以极端角度对眼睛进行反射（高光边缘）**。因此，反射率的增加主要出现在物体的边缘部分。此外，具有最大反射率增加的表面部分从相机的角度来看是被朝向缩短的，因此它们占据相对较少的像素。为了按比例显示菲涅耳曲线的不同部分，以反映它们的视觉突出性，图9.22中的菲涅耳反射率图和颜色条以及图9.20下半部分的条带都是相对于sin(θi)绘制，而不是直接绘制在θi上。图9.21说明了为什么sin(θi)是选择此用途的适当坐标轴。 

<img src="Phisically%20Based%20Shading.assets/1694326279601.png" alt="1694326279601" style="zoom:67%;" />

**Schlick`s approximation:**
$$
F(\mathbf{n}, \mathbf{l})\approx F_0 + (1-F_0)(1-(\mathbf{n}\cdot \mathbf{l})^+)^5\tag{9.16}
$$
<img src="Phisically%20Based%20Shading.assets/1694327021212.png" alt="1694327021212" style="zoom: 67%;" />

对大多数材料，Schlick公式已经做到了对fresnel函数较好的拟合，除了部分材料（上图最后一行，**注意到这些材料都是并非单调递增，而是有着一个小dip的情况**），即使是这些材料，Schlick拟合公式的误差依旧是可控的。

对于金属材料，可以采用更精确但计算成本更高的拟合公式。

使用Schlick近似时，F0是控制菲涅耳反射率的唯一参数。这很方便，因为F0具有明确定义的有效值范围[0,1]，可以使用标准的颜色选择界面进行设置，并且可以使用为颜色设计的纹理格式进行着色。此外，对于许多真实世界材料，有F0的参考值可用。折射率也可以用来计算F0。通常假设n1 = 1，这是对空气折射率的一个近似值，并使用n代替n2表示物体的折射率。这个简化后的方程如下所示： 
$$
F_0 = (\frac{n-1}{n+1})^2\tag{9.17}
$$
 即使使用复数折射率（例如金属的折射率），该方程也适用，只需使用（复数）结果的幅值即可。在折射率在可见光谱上有显著变化的情况下，为了计算准确的F0的RGB值，需要首先在波长的密集采样下计算F0，然后使用第8.1.3节中描述的方法将得到的光谱向量转换为RGB值。 

在一些应用中，可以采用以下近似，以达到更多的艺术效果和控制：
$$
F\approx F_0 +(F_{90}-F_0)(1-(\mathbf{n}\cdot \mathbf{l})^+)^{\frac{1}{p}}\tag{9.18}
$$
参数$F_{90}$为入射角90°时的F值，在以往的近似公式中都直接设为了1，为了实现一些艺术效果，这里单独作为参数可更改。而另一个参数p的加入，使得函数的形状(主要是趋近90°时的sharpnesss)可以被控制。

 此外，将F90设置为除白色以外的颜色也有助于匹配那些无法通过菲涅尔方程很好描述的材料，例如表面覆盖着细小尘埃的物体，尘埃颗粒的尺寸与光波长相当。 

### 9.5.2 Typical Fresnel Reflectance Values

 就其光学特性而言，物质可以分为三个主要的群体。第一类是绝缘体；第二类是金属，也称为导体；第三类是半导体，它们的特性介于绝缘体和金属之间。 

#### 9.5.2.1 Dielectric

 在日常生活中遇到的大多数物质都是绝缘体，包括玻璃、皮肤、木材、头发、皮革、塑料、石头和混凝土等。水也是一种绝缘体。最后一点可能令人惊讶，因为在日常生活中，水被认为具有导电性，但这种导电性是由于各种杂质引起的。绝缘体的F0值通常很低，一般为0.06或更低。在正入射时，这种低反射率使得菲涅尔效应特别明显。绝缘体的光学特性在可见光谱范围内很少有明显变化，导致反射率值呈无色。常见绝缘体的F0值列在表9.1中。这些值是标量，而不是RGB值，因为对于这些材料来说，RGB通道之间的差异并不显著。为方便起见，表9.1包括了线性值以及使用sRGB转换函数（通常在纹理绘制应用中使用的形式）编码的8位值。 

<img src="Phisically%20Based%20Shading.assets/1694398356757.png" alt="1694398356757" style="zoom:80%;" />

 各种绝缘体在外部反射时的F0值。每个值以线性数值、纹理值（非线性编码的8位无符号整数）和颜色示意图的形式给出。如果给出了一系列值，则颜色示意图位于该范围的中间。请注意，这些是镜面反射的颜色。例如，宝石通常具有鲜明的颜色，但这些颜色来自于物质内的吸收，与其菲涅耳反射无关。 （理解：就像玻璃本身是无色的，有色玻璃并不是SiO2本身有色，而是加入了色素物质）

对于未知的绝缘体物质，**0.04是一个合适的默认值。**

**一旦光线传播进入绝缘体，它可能会进一步散射或吸收。(与后文金属会被立即吸收形成对比）** 

#### 9.5.2.2 Metals

金属的F0值通常很高，几乎总是0.5或更高。一些金属的光学特性在可见光谱范围内有所变化，导致具有颜色的反射率值。表9.2显示了一些金属的F0值。 与表9.1类似，表9.2中也包括线性值和用于纹理的8位sRGB编码值。然而，在这里我们给出RGB值，因为许多金属具有彩色的菲涅尔反射。这些RGB值是使用sRGB（和Rec. 709）的原色和白点定义的。金的F0值略有不同。它是最具有色彩的金属之一，红色通道值略高于1（它刚好超出了sRGB/Rec. 709的色域范围），而蓝色通道值则特别低（是表9.2中唯一一个明显低于0.5的值）。金也是最亮的金属之一，从表中可以看出其亮度排在前列，按提高的亮度排序。金的明亮和强烈的彩色反射很可能对其在历史上具有独特的文化和经济意义做出了贡献。 请注意，**金属会立即吸收所有经过的光线，因此它们不会显示任何次表面散射或透明性。金属的可见颜色完全来自F0**。 

<img src="Phisically%20Based%20Shading.assets/1694399811113.png" alt="1694399811113" style="zoom: 80%;" />

#### 9.5.2.3 Semi-conductors

 正如人们所预期的那样，半导体的F0值介于最亮的绝缘体和最暗的金属之间，如表9.3所示。在实际应用中，很少需要渲染这种物质，因为大多数渲染场景中不会出现大量的晶体硅块。对于实际目的而言，除非您有意尝试模拟一种奇特或不切实际的材质，否则应避免使用0.2至0.45之间的F0值范围。 

<img src="Phisically%20Based%20Shading.assets/1694400302180.png" alt="1694400302180" style="zoom:80%;" />

#### 9.5.2.4 Fresnel Refectance Values in Water

前面的讨论都有一个默认的前提：空气中。水中物体的F_0显然与空气中不同。下面的公式揭示了更一般的F_0计算（与公式9.17对比）
$$
F_0= (\frac{n_1-n_2}{n_1+n_2})^2\tag{9.19}
$$
<img src="Phisically%20Based%20Shading.assets/1694401365953.png" alt="1694401365953" style="zoom: 67%;" />

水中与空气中的F_0的差异对绝缘体来说更为明显（见上图）。

#### 9.5.2.5  Parameterizing Fresnel Values 

工程中，往往引用一个标量:**金属度(metalness)**来控制F_0与漫反射系数，记为m。

定义一个$c_{surf}$表示平面颜色，那么当$m = 0$时，$F_0 = 0.04$(或额外设置)， $\rho_{ss} = c_{surf}$

$m = 1$时，$F_0 = c_{surf}$, $\rho_{ss} = 0$

更详细的讨论留到微表面模型之后。

### 9.5.3 Internal reflection

<img src="Phisically%20Based%20Shading.assets/1694410436529.png" alt="1694410436529" style="zoom:67%;" />

与external reflection不同的是，internaln reflection存在一个**临界角(critical angle)**，当入射角大于临界角时，会导致计算出的折射角大于90度，导致实际上没有折射光线，这种现象被称为**全反射(total internal reflection)**。

**Snell`s Law:**
$$
\frac{n_1}{n_2} = \frac{\sin\theta_2}{\sin\theta_1}\tag{9.20}\\
\theta_2 = \arcsin{(\frac{n_1}{n_2}\sin\theta_1)}
$$
(推导：) [物理光学-Snell定律 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/376519238) 

在图9.23中，具体表达为：
$$
\frac{n_2}{n_1} = \frac{\sin\theta_i}{\sin\theta_t}, n_2=1, n_1 = 3
$$
由snell` law，推导critical angle为：
$$
\theta_c = \arcsin{\frac{n_2}{n_1}}\tag{9.21}
$$
Fresnel方程是对称的，这意味着入射和传输向量可以互换，反射率保持不变。结合斯涅尔定律，这种对称性意味着内部反射的F(θi)曲线将类似于外部反射曲线的“压缩”版本。F0的值对于两种情况都是相同的，而内部反射曲线在θc处达到完全反射 

即
$$
F_2(\theta_2) = F_1(\arcsin{(\frac{n_2}{n_1}\sin\theta_1)})\tag{9.22}
$$
注意到：
$$
F_0 = (\frac{n_1-n_2}{n_1+n_2})^2 = (\frac{1-\frac{n_1}{n_2}}{1+\frac{n_1}{n_2}})^2\\
$$

$$
\frac{n_1}{n_2} = \frac{1-\sqrt{F_o}}{1+\sqrt{F_0}}\tag{9.23}
$$

![1694414440424](Phisically%20Based%20Shading.assets/1694414440424.png)

**上图：以$F_0 = 0.04$的Schlick拟合fresnel方程，下图为RT书上的图：**

<img src="Phisically%20Based%20Shading.assets/1694414674437.png" alt="1694414674437" style="zoom:50%;" />

 在内部反射的情况下，平均反射率较高。例如，这就是为什么在水下看到的气泡具有高反射、银色的外观。 

## 9.6 Microgeometry

前提假设：符合几何光学，每个微表面至少大于1倍光的波长。

由于每个微表面的法线朝向具有一定的随机性，因此可以将其建模为统计上的随机分布函数。该随机分布具有以下特点：

1. 一般情况下是连续的
2.  a strong peak at the macroscopic surface normal 
3.  The “tightness” of this distribution is determined by the surface roughness. The rougher the surface, the more “spread out” the microgeometry normals will be. （ 个分布的"紧密程度"由表面粗糙度决定。表面越粗糙，微几何法线就会更加"分散"。）

 增加微观粗糙度的可见效果是反射环境细节更加模糊。对于小型明亮光源来说，**这种模糊效果导致了更宽且更暗淡的镜面高光**。粗糙表面产生的高光较暗淡，是因为光能扩散到更宽的锥体中。 

**法线的分布函数既可以是各向同性的(大部分情况)，也可以是各向异性的(如下图左的情况)**。

<img src="Phisically%20Based%20Shading.assets/1694416384584.png" alt="1694416384584" style="zoom:50%;" />

 一些表面具有高度结构化的微观几何形态，导致多种微观尺度法线分布和表面外观。织物是一个常见的例子，天鹅绒和缎子的独特外观是由它们微观几何结构所决定的。织物模型将在第9.10节中进行讨论。 

尽管多个表面法线是微观几何对反射率的主要影响，但还有其他影响也可能很重要。阴影效应是指微观尺度表面细节对光源的遮挡，如下左侧所示。遮盖效应指的是一些微表面将其他表面从相机中隐藏起来，如图中间所示。

![1694416543208](Phisically%20Based%20Shading.assets/1694416543208.png)

shadow与occlusion的区别：shadow是光照不到表面，而occlusion是光能够照到表面，但是无法从表面反射出来。

微表面的高度差可能也会对法线分布产生很大的影响，此时，阴影和遮蔽的效果比较明显(阴影和遮蔽来自于微表面之间的高度不平)。

下图是一个经典场景，在该场景中，表面突起的部分被天气环境等因素风化/腐蚀变得较为光滑平整，但凹陷在下面的部分仍然十分粗糙，且突起的部分对下面的粗糙表面造成了遮蔽。当光接近法线入射上，凹陷的粗糙表面能够接受到光照并反射；然而当光接近边缘角度入射时，由于阴影和遮蔽作用，凹陷的粗糙表面无法接受或反射光线，因此视觉效果更为粗糙。

<img src="Phisically%20Based%20Shading.assets/1694417003792.png" alt="1694417003792" style="zoom:67%;" />

**对于所有类型的表面，随着入射角度θi增大，表面的可见不规则性的尺寸减小。在极度斜视的角度下，这种效应可以使不规则性的可见尺寸变得比光的波长还短，从而在光的反应中它们会"消失"。这两种效应与菲涅尔效应结合起来，使表面在观察角度和照射角度接近90°时呈现高反射和镜面效果。**

被微观尺度表面细节遮挡的光并不会消失，它会被反射，可能会反射到其他微观几何结构上。在到达眼睛之前，光线可能会以这种方式**经历多次反射**。这种相互反射现象在图9.27的右侧显示出来。由于每次反射光都会受到菲涅尔反射的衰减，因此在介质中相互反射往往是微妙的。**在金属中，多次反射是任何可见漫反射的来源，因为金属没有次表面散射**。来自彩色金属的多次反射比原始反射更深色，因为它们是光与表面多次交互的结果。

到目前为止，我们已经讨论了微观几何对于镜面反射即表面反射的影响。在某些情况下，微观尺度表面细节也会影响次表面反射。如果微观几何的不规则性大于次表面散射距离，那么阴影效应和遮盖效应可以产生**反射型反射**效应，即光线会优先向入射方向反射。（ **反射型反射（Retroreflection）是指光线在撞击表面后，以相反的方向返回的现象。这种反射是由特殊的表面结构或材料所引起的，它使得光线在撞击表面后保持几乎不变的方向**。 ）这种效应发生的原因是当观察方向和照明方向差异很大时，**阴影和遮盖会遮挡亮光区域**。参见图9.29。

<img src="Phisically%20Based%20Shading.assets/1694417547682.png" alt="1694417547682" style="zoom:67%;" />

## 9.7 Microfacet theory

对上述微表面几何的定量研究和建模：微表面反射模型(**Cook and Torrance in 1981**)

建模：平面是有很多微表面组成的，每个微表面具有自己的法线：$\mathbf{m}$，和自己的BRDF：$f_{\mu}(\mathbf{l}, \mathbf{v}, \mathbf{m})$，每个微表面可以被视为完全镜面（一般情况下，其他应用也可以建模为具有漫反射甚至衍射的表面）

下面的各个函数请搭配9.8对应具体实践食用

**NDF：Normal distribution fuction 微表面法线分布函数**

$D(\mathbf{m})$满足：
$$
\int_{\mathbf{m}\in\Theta}D(\mathbf{m})(\mathbf{n}\cdot\mathbf{m})d\mathbf{m} = 1\tag{9.24}
$$



Why? 下面的补充材料将解答疑惑：

### 补充材料3：

Heitz, Eric, “Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs,” Journal of Computer Graphics Techniques, vol. 3, no. 4, pp. 48–107, 2014. Cited on p. 332, 333, 334, 335, 336, 337, 339, 344

#### Ex3.2.1:   Measuring Radiance on a Surface 

<img src="Phisically%20Based%20Shading.assets/1694576643954.png" alt="1694576643954" style="zoom:50%;" />

目标：对于由一组微表面组成的表面，如何将微表面的radiance 聚合成宏观表面的radiance?
$$
L(\omega_0, \mathcal{M}) = \frac{\int_{\mathcal{M}}\text{projected area}(p_m)L(\omega_0, p_m)dp_m}{\int_{\mathcal{M}}\text{projected area}(p_m)}\tag{1}
$$
为什么要除以面积积分？量纲！而且将M简化为一个点，其radiance应该是radiance的平均值，为什么不是积分或和？**radiance是密度！将M整体看待，简化为一个点时，其radiance作为密度值应该是各点密度的平均值而非密度的和。**

#### Ex3.2.2:  Microfacet Statistics  

![1694577193096](Phisically%20Based%20Shading.assets/1694577193096.png)

**微表面模型的建模:**

我们考虑一个平面区域的表面，我们称之为"几何表面(geometric surface)" G(**黑线部分**)，按照惯例其面积为1(平方米)： $\int_{\mathcal{G}}dA = 1$

 微平面模型假设真实表面以微平面的集合形式偏离了这个表面，我们把这个集合称为"microsurface" M(**红线部分**)。准确地说，如果$ω_g$是几何表面G的法线向量，那么M就是沿着ωg在G上投影的微平面点的集合。微表面M的每个点$p_m$都有一个法线向量$ω_m(p_m)$，即$ω_m: M → Ω$(**说明：这里的$\Omega$指的是单位球面，而非正球面，在这里等同于记号$\Theta$**)是一个从微表面上的点到该点处的表面法线向量的函数。我们将该向量的三个坐标表示为(xm, ym, zm)。 

在以上模型定义下，我们进一步定义M上的统计学性质：

**NDF的定义：**

注意，D**实际上是几何表面每平方米的法线分布**，这就是为什么它的单位是m²/sr而不是1/sr
$$
D(\omega) = \int_{\mathcal{M}}\delta_{\omega}(\omega_m(p_m))dp_m\tag{2}
$$
$\Omega^\prime\subset \Omega$，对应$\mathcal{M}^\prime\subset \mathcal{M}$
$$
\int_{\Omega^\prime}D(\omega_m)d\omega_m = \int_{\mathcal{M}^\prime}dp_m\tag{3}
$$
证明：
$$
\int_{\Omega^\prime}D(\omega_m)d\omega_m = \int_{\Omega^\prime} \int_{\mathcal{M}}\delta_{\omega}(\mathbf{\omega_m}(p_m))dp_md\omega_m
$$


## 9.8 BRDF Model for surface refection

除了少数例外，物理渲染中使用的镜面BRDF项是基于微平面理论推导出来的。在镜面表面反射的情况下，**每个微平面都是一个完全光滑的菲涅尔镜面**。回想一下，这样的镜面将每个入射光线反射成一个**单一的反射方向**。这意味着每个微平面facet的微BRDF $f_µ(l, v, m)$只有在v与l的反射方向平行时才不为零。对于给定的l和v向量，这种配置相当于微平面法线m与指向l和v恰好在中间的向量对齐。这个向量就是**半程向量h**。它通过将v和l相加并对结果进行归一化来计算。 
$$
\mathbf{h} = \frac{\mathbf{l}+\mathbf{v}}{||\mathbf{l}+\mathbf{v}||}
$$

### 9.8.1 NDF

#### 9.8.1.1 Isotropic NDF

**Beckmann NDF** 是光学界开发的第一种微平面模型中使用的法线分布。它如今在该领域仍被广泛使用。它也是Cook-Torrance BRDF中选择的NDF。规范化的Beckmann分布具有以下形式： 
$$
D(\mathbf{m}) = \frac{\chi^+(\mathbf{n}\cdot\mathbf{m})}{\pi \alpha_b^2 (\mathbf{n}\cdot\mathbf{m})^4}\exp(\frac{(\mathbf{n}\cdot\mathbf{m})^2-1}{\alpha_b^2(\mathbf{n}\cdot\mathbf{m})^2})
$$
 参数$α_b$控制着表面的粗糙度。它与微几何表面的坡度的均方根(RMS)成正比，因此$α_b$ = 0表示一个完全光滑的表面。 

## 工程篇--mitsuba BSDFs

**BSDF=BRDF+BTDF**：既有反射，又有折射；BSDF：表面**散射**模型，我们考虑的不再是半球面而是整个球面